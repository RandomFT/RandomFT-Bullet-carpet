--- ../src-base/minecraft/net/minecraft/world/WorldEntitySpawner.java
+++ ../src-work/minecraft/net/minecraft/world/WorldEntitySpawner.java
@@ -21,14 +21,30 @@
 import net.minecraft.util.math.MathHelper;
 import net.minecraft.world.biome.Biome;
 import net.minecraft.world.chunk.Chunk;
+import net.minecraft.entity.monster.EntityEvoker;
+import net.minecraft.entity.monster.EntityVindicator;
+import net.minecraft.entity.monster.EntityVex;
 
+import net.minecraft.world.gen.structure.StructureBoundingBox;
+import net.minecraft.world.gen.structure.WoodlandMansion;
+
+
+
+import net.minecraft.entity.EntityList;
+import carpet.utils.SpawnReporter;
+import carpet.CarpetSettings;
+import java.lang.Math;
+import net.minecraft.util.Tuple;
+
 public final class WorldEntitySpawner
 {
+
     private static final int field_180268_a = (int)Math.pow(17.0D, 2.0D);
     private final Set<ChunkPos> field_77193_b = Sets.<ChunkPos>newHashSet();
 
     public int func_77192_a(WorldServer p_77192_1_, boolean p_77192_2_, boolean p_77192_3_, boolean p_77192_4_)
     {
+
         if (!p_77192_2_ && !p_77192_3_)
         {
             return 0;
@@ -72,19 +88,54 @@
                 }
             }
 
+            //CM start
+            boolean optimizedDespawnRange = CarpetSettings.optimizedDespawnRange;
+            if (i==0 && optimizedDespawnRange) // worlds without valid chunks are skipped.
+            {
+                return 0;
+            }
+            //CM end
             int j4 = 0;
             BlockPos blockpos1 = p_77192_1_.func_175694_M();
+            //CM start
+            int did = p_77192_1_.field_73011_w.func_186058_p().func_186068_a();
+            String level_suffix = (did==0)?"":((did<0?" (N)":" (E)"));
+            //CM end
 
             for (EnumCreatureType enumcreaturetype : EnumCreatureType.values())
             {
+                //CM start
+                String type_code = String.format("%s", enumcreaturetype);
+                String group_code = type_code+level_suffix;
+                if (SpawnReporter.track_spawns > 0L)
+                {
+                    SpawnReporter.overall_spawn_ticks.put(group_code, SpawnReporter.overall_spawn_ticks.get(group_code) + SpawnReporter.spawn_tries.get(type_code));
+                }
+                //CM end
                 if ((!enumcreaturetype.func_75599_d() || p_77192_3_) && (enumcreaturetype.func_75599_d() || p_77192_2_) && (!enumcreaturetype.func_82705_e() || p_77192_4_))
                 {
                     int k4 = p_77192_1_.func_72907_a(enumcreaturetype.func_75598_a());
-                    int l4 = enumcreaturetype.func_75601_b() * i / field_180268_a;
-
+                    //CM replaced: //int l4 = enumcreaturetype.getMaxNumberOfCreature() * i / MOB_COUNT_DIV;
+                    int l4 = (int)(Math.pow(2.0,(SpawnReporter.mobcap_exponent/4)) * enumcreaturetype.func_75601_b() * i / field_180268_a);
+                    SpawnReporter.mobcaps.get(did).put(enumcreaturetype, new Tuple<>(k4, l4));
+                    int tries = SpawnReporter.spawn_tries.get(type_code);
+                    if (SpawnReporter.track_spawns > 0L)
+                    {
+                        SpawnReporter.spawn_attempts.put(group_code, SpawnReporter.spawn_attempts.get(group_code) + tries);
+                        SpawnReporter.spawn_cap_count.put(group_code, SpawnReporter.spawn_cap_count.get(group_code) + k4);
+                    }
+                    if (SpawnReporter.mock_spawns) { k4 = 0; } // no mobcaps
+                    //CM end
+                    
                     if (k4 <= l4)
                     {
                         BlockPos.MutableBlockPos blockpos$mutableblockpos = new BlockPos.MutableBlockPos();
+                      /* carpet mod -> extra indentation */
+                      for (int trie = 0; trie < tries; trie++)
+                      {
+                        long local_spawns = 0;
+                        /* end */
+                        
                         label134:
 
                         for (ChunkPos chunkpos1 : this.field_77193_b)
@@ -108,6 +159,8 @@
                                     Biome.SpawnListEntry biome$spawnlistentry = null;
                                     IEntityLivingData ientitylivingdata = null;
                                     int l3 = MathHelper.func_76143_f(Math.random() * 4.0D);
+                                    //CM fixed 4 mobs per pack
+                                    if (CarpetSettings._1_8Spawning) { l3 = 4; }
 
                                     for (int i4 = 0; i4 < l3; ++i4)
                                     {
@@ -132,6 +185,33 @@
 
                                             if (p_77192_1_.func_175732_a(enumcreaturetype, biome$spawnlistentry, blockpos$mutableblockpos) && func_180267_a(EntitySpawnPlacementRegistry.func_180109_a(biome$spawnlistentry.field_76300_b), p_77192_1_, blockpos$mutableblockpos))
                                             {
+                                                if (CarpetSettings.mansionMobsRespawn && isInsideMansion(p_77192_1_, blockpos$mutableblockpos)) {
+                                                    Class<? extends EntityLiving>[] mansionMobs = new Class[]{
+                                                            EntityEvoker.class,
+                                                            EntityVindicator.class,
+                                                            EntityVex.class
+                                                    };
+
+                                                    try {
+                                                        Class<? extends EntityLiving> mobClass = mansionMobs[p_77192_1_.field_73012_v.nextInt(mansionMobs.length)];
+                                                        EntityLiving mob = mobClass.getConstructor(World.class).newInstance(p_77192_1_);
+
+                                                        mob.func_70012_b(
+                                                                blockpos$mutableblockpos.func_177958_n() + 0.5,
+                                                                blockpos$mutableblockpos.func_177956_o(),
+                                                                blockpos$mutableblockpos.func_177952_p() + 0.5,
+                                                                p_77192_1_.field_73012_v.nextFloat() * 360.0F,
+                                                                0.0F
+                                                        );
+
+                                                        p_77192_1_.func_72838_d(mob);
+                                                        continue label134;
+                                                    }
+                                                    catch (Exception e) {
+                                                        e.printStackTrace();
+                                                    }
+                                                }
+
                                                 EntityLiving entityliving;
 
                                                 try
@@ -153,7 +233,29 @@
                                                     if (entityliving.func_70058_J())
                                                     {
                                                         ++j2;
-                                                        p_77192_1_.func_72838_d(entityliving);
+                                                        //CM replacing //worldServerIn.spawnEntityInWorld(entityliving);
+                                                        if (optimizedDespawnRange && entityliving.willImmediatelyDespawn()) // Added optimized despawn mobs causing netlag by Luflosi CARPET-XCOM
+                                                        {
+                                                            entityliving.func_70106_y();
+                                                        }
+                                                        else
+                                                        {
+                                                            ++local_spawns;
+                                                            if (SpawnReporter.track_spawns > 0L)
+                                                            {
+                                                                String species = EntityList.func_75621_b(entityliving);
+                                                                SpawnReporter.registerSpawn(entityliving, type_code, species, blockpos$mutableblockpos);
+                                                            }
+                                                            if (SpawnReporter.mock_spawns)
+                                                            {
+                                                                entityliving.func_70106_y();
+                                                            }
+                                                            else
+                                                            {
+                                                                p_77192_1_.func_72838_d(entityliving);
+                                                            }
+                                                            //CM end
+                                                        }
                                                     }
                                                     else
                                                     {
@@ -173,7 +275,30 @@
                                 }
                             }
                         }
+                        /* carpet mod */
+                        
+                        if (SpawnReporter.track_spawns > 0L)
+                        {
+                            if (local_spawns > 0)
+                            {
+                                SpawnReporter.spawn_ticks_succ.put(group_code, SpawnReporter.spawn_ticks_succ.get(group_code) + 1L);
+                                SpawnReporter.spawn_ticks_spawns.put(group_code, SpawnReporter.spawn_ticks_spawns.get(group_code) + local_spawns);
+                            }
+                            else
+                            {
+                                SpawnReporter.spawn_ticks_fail.put(group_code, SpawnReporter.spawn_ticks_fail.get(group_code) + 1L);
+                            }
+                        }
+                      } //carpet mod <- extra indentation
                     }
+                    else //carpet mod full mobcap
+                    {
+                        if (SpawnReporter.track_spawns > 0L)
+                        {
+                            SpawnReporter.spawn_ticks_full.put(group_code, SpawnReporter.spawn_ticks_full.get(group_code) + SpawnReporter.spawn_tries.get(type_code));
+                        }
+                    }
+                    /* end */
                 }
             }
 
@@ -298,4 +423,14 @@
             }
         }
     }
+    private static boolean isInsideMansion(World world, BlockPos pos) {
+        for (StructureBoundingBox box : WoodlandMansion.mansionBoxes) {
+            if (box.func_175898_b(pos)) {
+                return true;
+            }
+        }
+        return false;
+    }
+
+
 }
